import{V as ue,g as me,O as Q,m as G,M as J,b as F,T as ge,X as be,S as K,I as $,a as fe,c as Le,d as he,_ as _e,e as Se,f as xe,h as Ce,i as Ie,j as we,k as Ne,l as ke,n as Me,o as Te,p as De,F as We,P as Oe,q as ve,r as Ae}from"./OLCesium-a7b295b6.js";import{_ as Ee,r as ze,f as ee,g as Be,$ as H,n as te,c as S,a as u,h as ae,i as h,j as x,m as P,k as je,l as Ve,q as oe,u as Re,o as f}from"./index-26e23dd5.js";const Fe={props:{},setup(X,{emit:c}){const C=G,t=Re(),e=ze({defaultCenter:[121.326776,24.655499],defaultCenterZoom:14,targetNum:1,conditionWrap:!1,layerSelect:!1,currentLayers:[],layers:[],mapLayers:ee(()=>e.layers.map((s,a)=>({label:s.group_title,value:s.value,layers:s.group_layers,groupClass:s.group_class}))),selectLock:!1,mapCount:1,map1:null,map2:null,map1LayerStatus:[],map2LayerStatus:[],temp:{map1BaseStatus:0,map2BaseStatus:0},deleteLightbox:!1,dimensionMap:{map1:"2D",map2:"2D"},toSearchDimensionStatus:ee(()=>{let s=e.targetNum==1?"map1":"map2";return e.dimensionMap[s]==="2D"}),ol3d:null,selectValueTemp:0,popup:{nodeRef:null,overlay:null,popupId:0,coordinate:[],popupData:""},comSize:{wrapHeight:"",wrapWidth:""},tribeQuery:{}});let L=null;const O=new ue({projection:"EPSG:4326",center:e.defaultCenter,zoom:e.defaultCenterZoom});function q(){e.map1=new J({target:"map1",layers:[F.getBaseMapData(0)],view:O,controls:[]}),e.map1.addControl(new Me({units:"metric"}))}function Y(s,a){const n=new Te({source:new De({features:[new We({geometry:new Oe([s,a]),population:4e3,rainfall:500})]}),style:new K({image:new $({anchor:[.5,100],anchorXUnits:"fraction",anchorYUnits:"pixels",src:ve})})});let r=e.targetNum==1?"map1":"map2";e[r].addLayer(n)}function v({action:s,value:a}){var p;let n=((p=e.map1)==null?void 0:p.getTarget())==null?"map2":"map1",r=e[n].getView();switch(s){case"In":r.animate({zoom:r.getZoom()+1});break;case"Out":r.animate({zoom:r.getZoom()-1});break;case"toNorth":r.animate({rotation:0});break;case"moveTo":if(a){const{xAxis:m,yAxis:T}=a;r.animate({center:[m,T],zoom:17,duration:100})}else navigator.geolocation.getCurrentPosition(function(m){r.animate({center:[m.coords.longitude,m.coords.latitude],zoom:17,duration:100}),Y(m.coords.longitude,m.coords.latitude)});break;case"fullScreen":let l=document.getElementById(`map${e.targetNum}`);l.requestFullscreen?l.requestFullscreen():l.msRequestFullscreen?l.msRequestFullscreen():l.mozRequestFullScreen?l.mozRequestFullScreen():l.webkitRequestFullscreen&&l.webkitRequestFullscreen();break}}function I({action:s,value:a}){var m,T;let n=e.targetNum==1?e.map1:e.map2,r=n==null?void 0:n.getLayers();switch(s){case"layerMode":if(a.checked){e.layers[a.nodeIndex].group_layers[a.subNodeIndex].single_tiles||(r.getArray().forEach(b=>{b.get("id")&&b.get("id").includes(`node${a.nodeIndex}_subNode${a.subNodeIndex}_nestedSubNode`)&&n.removeLayer(b)}),M("delete",n.getTarget(),a.id));let i=a.nestedSubNodeIndex||e.selectValueTemp,y=C.getLayer(e.layers[a.nodeIndex].group_layers[a.subNodeIndex],i,a.id);if(n.addLayer(y),(m=y.get("label"))!=null&&m.includes("雷達回波預測")){var p=y.getSource(),l=p.getFeatures()[0];const g=e.layers[a.nodeIndex].group_layers[a.subNodeIndex].image_options.image_extent,b=y.get("extra").url,R=gifler(b),U=g[2]-g[0],k=g[3]-g[1];R.frames(document.createElement("canvas"),function(W,_){const de=U/_.width,ce=k/_.height,pe=Math.min(de,ce),ye=e.map1.getView().getResolution();l.setStyle(new K({image:new $({img:W.canvas,imgSize:[_.width,_.height],opacity:.8,scale:pe/ye})})),W.clearRect(0,0,_.width,_.height),W.drawImage(_.buffer,_.x,_.y),n.render()},!0)}e.layers[a.nodeIndex].group_layers[a.subNodeIndex].layer_type==="WFS"&&(E(n,y.label),d(a)),M("add",n.getTarget(),a.id)}else{let y=function(R){i.filter(k=>{var W;return(W=k==null?void 0:k.get("id"))==null?void 0:W.includes(R)}).forEach(k=>{n.removeLayer(k)})},i=r.getArray();const b={node9_subNode0_nestedSubNode:"node9_subNode0_nestedSubNode",node12_subNode1_nestedSubNode:"node12_subNode1_nestedSubNode"}[a.id]||a.id;y(b),e.layers[a.nodeIndex].group_layers[a.subNodeIndex].layer_type==="WFS"&&(d(a),e.popup.popupId=0,e.popup.popupData="",e.popup.overlay&&(n.removeOverlay(e.popup.overlay),e.popup.overlay=null)),M("delete",n.getTarget(),a.id)}break;case"selectLayerMode":if(e.selectLock)return;a.layerName==="all"?r.getArray().filter(g=>g.get("id")!==void 0).forEach(g=>{n.removeLayer(g)}):r.getArray().forEach(y=>{y.get("id")==a.id&&n.removeLayer(y)});break;case"changeOrder":if(e.selectLock)return;let{nodeIndex:D,subNodeIndex:w,nestedSubNodeIndex:z}=C.getLayerIndex(a.id),j=C.getLayer(e.layers[D].group_layers[w],z,a.id);if(a.movement==="up"){if(a.key+1==r.getArray().length)return;let i={checked:!1,nodeIndex:D,subNodeIndex:w,nestedSubNodeIndex:z,id:a.id};I({action:"layerMode",value:i}),r.insertAt(a.key+1,j)}if(a.movement==="down"){if(a.key-1==0)return;let i={checked:!1,nodeIndex:D,subNodeIndex:w,nestedSubNodeIndex:z,id:a.id};I({action:"layerMode",value:i}),r.insertAt(a.key-1,j)}break;case"changeLayerVisible":if(e.selectLock)return;let re=!r.getArray()[a.key].getVisible();r.getArray()[a.key].setVisible(re);break;case"baseMap":e.temp[`map${e.targetNum}BaseStatus`]=a.baseId;let se=new ge({preload:1/0,name:a.name,label:a.label,type:a.mapType,baseId:a.baseId,source:new be({url:a.url}),crossOrigin:"anonymous"}),ie=n==null?void 0:n.getLayers().getArray();r.insertAt(0,se),ie.forEach(i=>(i.get("type")=="base"&&i.get("baseId")!==a.baseId&&n.removeLayer(i),!0));break;case"changeMapCount":if(e.mapCount===a.qty)return;let N=e.targetNum!==1?"map1":"map2";e.mapCount=a.qty;let le=e[`${N}LayerStatus`].filter(i=>i!=="3D").map(i=>G.getLayerIndex(i));if(a.qty===2&&(e[N]=new J({target:N,layers:[F.getBaseMapData(0),...le.map(i=>C.getLayer(e.layers[i.nodeIndex].group_layers[i.subNodeIndex],i.nestedSubNodeIndex,i.id))],view:O,controls:[]}),((T=e[`${N}LayerStatus`])==null?void 0:T.indexOf("3D"))!==-1)){L=new Q({map:e[N]}),L.setEnabled(!0),Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NzM3MWFhYS0xMjNlLTQ3MTMtODFjZS0xZjMzM2I5NGZiYTEiLCJpZCI6MTMwODE4LCJpYXQiOjE2ODQwNzM3Mjl9.UYu4kBialPo19dcvosHzZTpg2BD1zkFQnjCD78YiiYo";let i=L.getCesiumScene({});i.terrainProvider=Cesium.createWorldTerrain({})}if(a.qty===1){e[N]=null;const i=document.getElementById(N);for(;i.firstChild;)i.removeChild(i.firstChild)}break;case"changeDimensionMap":let V=e.targetNum==1?"map1":"map2";if(e.dimensionMap[V]=a,a==="3D"){const y=r.getArray().find(b=>b.get("label").includes("近年歷史災害82處部落點位"));y&&e[`map${e.targetNum}`].removeLayer(y),L=new Q({map:n}),L.setEnabled(!0),Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NzM3MWFhYS0xMjNlLTQ3MTMtODFjZS0xZjMzM2I5NGZiYTEiLCJpZCI6MTMwODE4LCJpYXQiOjE2ODQwNzM3Mjl9.UYu4kBialPo19dcvosHzZTpg2BD1zkFQnjCD78YiiYo";let g=L.getCesiumScene({});g.terrainProvider=Cesium.createWorldTerrain({}),e[`${V}LayerStatus`].push("3D")}else L.setEnabled(!1),e[`${V}LayerStatus`]=e[`${V}LayerStatus`].filter(i=>i!=="3D"),e[`map${e.targetNum}LayerStatus`].forEach(i=>{let{nodeIndex:y,subNodeIndex:g,nestedSubNodeIndex:b}=C.getLayerIndex(i);return C.getLayer(e.layers[y].group_layers[g],b,a.id).get("label").includes("近年歷史災害82處部落點位")&&I({action:"layerMode",value:{checked:!0,nodeIndex:y,subNodeIndex:g,nestedSubNodeIndex:b,id:i}}),i});break;case"setOpacity":r.getArray()[a.key].setOpacity(Number(a.value));break}A()}function B(s){var n;e.targetNum=s;let a=e.targetNum!==1?"map1":"map2";if(e.mapCount===1){if(!e[`map${s}`]){let r=e[`map${s}LayerStatus`].filter(l=>l!=="3D");r.includes("node0_subNode4_nestedSubNodeundefined")&&(r=[...r.filter(m=>m!=="node0_subNode4_nestedSubNodeundefined"),"node0_subNode4_nestedSubNodeundefined"]);let p=r.map(l=>G.getLayerIndex(l));e[`map${s}`]=new J({target:`map${s}`,layers:[F.getBaseMapData(e.temp[`map${e.targetNum}BaseStatus`]),...p.map(l=>C.getLayer(e.layers[l.nodeIndex].group_layers[l.subNodeIndex],l.nestedSubNodeIndex,l.layeredIndex))],view:O,controls:[]}),E(e[`map${s}`]),((n=e[`map${s}LayerStatus`])==null?void 0:n.indexOf("3D"))!==-1&&(L=new Q({map:e[`map${s}`]}),L.setEnabled(!0))}if(e[a]){e[a]=null;const r=document.getElementById(a);for(;r.firstChild;)r.removeChild(r.firstChild)}}te(()=>{A()})}function A(){var n;let s=e.targetNum==1?e.map1:e.map2;const a=(n=s==null?void 0:s.getLayers())==null?void 0:n.getArray();e.currentLayers=a==null?void 0:a.map(r=>({label:r.get("label"),id:r.get("id"),visible:r.getVisible()}))}function Z(){e.conditionWrap=!e.conditionWrap}function M(s,a,n){if(s==="add")e[`${a}LayerStatus`].push(n);else if(s==="delete"){let r=e[`${a}LayerStatus`].findIndex(p=>p===n);e[`${a}LayerStatus`].splice(r,1)}else console.log("error")}function E(s){var n;let a=new fe({layers:(n=s==null?void 0:s.getLayers())==null?void 0:n.getArray(),condition:Le});s.addInteraction(a),a.on("select",r=>{let p=r.selected[0];if(p){e.popup.overlay=new he({element:e.popup.nodeRef,autoPan:!0,autoPanAnimation:{duration:250}}),e.popup.overlay.setPosition(r.mapBrowserEvent.coordinate),s.addOverlay(e.popup.overlay);let l=p.getId().split(".");e.popup.popupData=l[0],e.popup.coordinate=r.mapBrowserEvent.coordinate,l[0]==="新竹縣原住民部落範圍"&&(e.popup.popupId=p.get("編號")),l[0]==="近年歷史災害82處部落點位"&&(e.popup.popupId=l[1])}else s.removeOverlay(e.popup.overlay),e.popup.overlay=null,e.popup={nodeRef:null,overlay:null,popupId:0,coordinate:[],popupData:""}})}function o(){(e.targetNum==1?e.map1:e.map2).removeOverlay(e.popup.overlay),e.popup.overlay=null}function d(s){const{checked:a,id:n}=s;if(!a){e.selectLayerOption={};return}n==="node4_subNode0_nestedSubNodeundefined"&&H.ajax({url:"https://api.edtest.site/tribeQuery",method:"GET",success:r=>{e.tribeQuery=r},error:r=>{console.log(r)}})}function ne(s){let a={action:"moveTo",value:{xAxis:s.WGS84.lng,yAxis:s.WGS84.lat}};v(a)}return Be(async()=>{let s=H.ajax({url:"https://api.edtest.site/underLayers",method:"GET"}).done(n=>n),a=H.ajax({url:"https://api.edtest.site/layers",method:"GET"}).done(n=>n);Promise.all([s,a]).then(n=>{let r=n[0].data.map((p,l)=>({mapType:"base",baseId:l,onCurrent:!1,...p}));F.setBaseMapData(r),e.temp.map1BaseStatus=0,e.temp.baseMapList=me(),e.layers=n[1].map((p,l)=>(p.group_layers.forEach((m,T)=>{let D=T,w;m.id=`node${l}_subNode${D}_nestedSubNode${w}`,m.single_tiles||m.tiles_list.forEach((z,j)=>{w=j,z.id=`node${l}_subNode${D}_nestedSubNode${w}`})}),{...p,value:l})),te(()=>{q(),A()})}),e.comSize.wrapHeight=window.innerHeight,e.comSize.wrapWidth=window.innerWidth,window.onresize=n=>{e.comSize.wrapHeight=n.target.innerHeight,e.comSize.wrapWidth=n.target.innerWidth}}),{state:e,props:X,store:t,mapControl:v,layerControl:I,changeTarget:B,conditionWrap:Z,closeMapData:o,moveToMap:ne}}},Pe={class:"w-100 d-flex justify-content-between flex-sm-row flex-wrap flex-sm-nowrap mapWrap",id:"mapWrap"},qe={key:0,class:"middleLine"},Ye={class:"SearchBar d-none d-sm-block position-absolute"},Ze={class:"d-flex align-items-center"},Qe=u("img",{src:_e,alt:"",class:"me-5"},null,-1),Ge={class:"conditionCom d-none d-sm-block position-absolute"},Je={class:"mb-4"},He={key:1},Xe={class:"m-Navbar d-flex d-sm-none position-fixed bottom-0 start-0 w-100"},Ue={class:"position-absolute bottom-100 w-100",style:{"max-height":"70vh","overflow-y":"scroll"}},Ke={key:0},$e={key:0,class:"lightWrap w-100 h-100 d-flex justify-content-center align-items-center"},et={class:"p-4 rounded bg-white",style:{width:"250px"}},tt=u("p",{class:"text-center fw-bold"},"是否要刪除全部圖層",-1),at={class:"d-flex justify-content-around"};function ot(X,c,C,t,e,L){var M,E;const O=Se,q=xe,Y=Ce,v=Ie,I=Ae,B=we,A=Ne,Z=ke;return f(),S("div",null,[u("div",Pe,[u("div",{id:"map1",class:ae({"w-100":((M=t.state.map1)==null?void 0:M.getTarget())=="map1","h-100":t.state.mapCount===1,"h-50":t.state.mapCount===2&&t.state.comSize.wrapWidth<600})},null,2),t.state.mapCount===2?(f(),S("div",qe)):h("",!0),u("div",{id:"map2",class:ae({"w-100":((E=t.state.map2)==null?void 0:E.getTarget())=="map2","h-100":t.state.mapCount===1,"h-50":t.state.mapCount===2&&t.state.comSize.wrapWidth<600})},null,2)]),x(O,{class:"asideTool position-absolute top-50 translate-middle-y",id:"asideTool",onOnMapControl:c[0]||(c[0]=({action:o,value:d})=>{t.mapControl({action:o,value:d})})}),u("div",Ye,[u("div",Ze,[Qe,x(q,{class:"mapSourceOption d-none d-sm-block",baseMapList:t.state.temp.baseMapList,onChangeBaseMaps:({action:o,value:d})=>{t.layerControl({action:o,value:d})}},null,8,["baseMapList","onChangeBaseMaps"])]),x(Y,P({class:"mt-4"},{dimensionMapStatus:t.state.toSearchDimensionStatus,currentLayers:t.state.currentLayers,mapCount:t.state.mapCount,onChangeBaseMaps:({action:o,value:d})=>{t.layerControl({action:o,value:d})}},{onOnLayerControl:c[1]||(c[1]=({action:o,value:d})=>{t.layerControl({action:o,value:d})}),onOnChangeTarget:c[2]||(c[2]=o=>{t.changeTarget(o)}),onConditionWrap:c[3]||(c[3]=o=>{t.conditionWrap(o)})}),null,16)]),u("div",Ge,[u("div",Je,[t.state.conditionWrap?h("",!0):(f(),S("button",{key:0,class:"border-0 w-100 rounded-4 bg-steel text-white text-center p-2 fw-bold fs-5",onClick:c[4]||(c[4]=o=>t.state.conditionWrap=!0)}," 圖層選項 ")),t.state.conditionWrap?(f(),S("div",{key:1,class:"mb-4","on:onLayerControl":c[6]||(c[6]=({action:o,value:d})=>{t.layerControl({action:o,value:d})})},[x(v,P({tribeQuery:t.state.tribeQuery,mapLayers:t.state.mapLayers,currentLayers:t.state.currentLayers,onClose:()=>{t.state.conditionWrap=!1},showSelectLayerValue:o=>{t.state.selectValueTemp=o},moveToMap:o=>{t.moveToMap(o)}},{onOnLayerControl:c[5]||(c[5]=({action:o,value:d})=>{t.layerControl({action:o,value:d})})}),null,16)],32)):h("",!0),x(I,{text:"可選擇要加入的圖層",styles:"right: 105%;top: 0;text-align: right;"})]),u("div",null,[t.state.layerSelect?h("",!0):(f(),S("button",{key:0,class:"border-0 w-100 rounded-4 bg-steel text-white text-center p-2 fw-bold fs-5",onClick:c[7]||(c[7]=o=>t.state.layerSelect=!0)}," 已選擇的圖層 ")),t.state.layerSelect?(f(),S("div",He,[x(B,je(Ve({selectLock:t.state.selectLock,currentLayers:t.state.currentLayers,onClose:()=>{t.state.layerSelect=!1},onLockLayer:()=>{t.state.selectLock=!t.state.selectLock},onDeleteLayer:({action:o,value:d})=>{d.layerName=="all"?t.state.deleteLightbox=!0:t.layerControl({action:o,value:d})},onDeleteLayerAll:()=>{t.state.deleteLightbox=!0},onLayerControl:({action:o,value:d})=>{t.layerControl({action:o,value:d})}})),null,16)])):h("",!0),x(I,{text:"顯示已經選擇的圖層",styles:"right: 105%;top: 0;text-align: right;"})])]),u("div",Xe,[u("div",Ue,[t.state.conditionWrap?(f(),oe(v,P({key:0,class:"w-100"},{mapLayers:t.state.mapLayers,currentLayers:t.state.currentLayers,onClose:()=>{t.state.conditionWrap=!1},showSelectLayerValue:o=>{t.state.selectValueTemp=o}},{onOnLayerControl:c[8]||(c[8]=({action:o,value:d})=>{t.layerControl({action:o,value:d})})}),null,16)):h("",!0)]),t.state.layerSelect?(f(),S("div",Ke,[x(B,P({class:"position-absolute bottom-100 w-100"},{selectLock:t.state.selectLock,currentLayers:t.state.currentLayers,onClose:()=>{t.state.layerSelect=!1},onChangLayerVisible:o=>{t.layerControl(o)},onChangeOrderLayer:({action:o,value:d})=>{t.layerControl({action:o,value:d})},onLockLayer:()=>{t.state.selectLock=!t.state.selectLock},onDeleteLayer:({action:o,value:d})=>{d.layerName=="all"?t.state.deleteLightbox=!0:t.layerControl({action:o,value:d})},onDeleteLayerAll:()=>{t.state.deleteLightbox=!0},setOpacity:({action:o,value:d})=>{t.layerControl({action:o,value:d})}}),null,16)])):h("",!0),x(A,{dimensionMapStatus:t.state.toSearchDimensionStatus,currentLayers:t.state.currentLayers,mapCount:t.state.mapCount,openConditionWrap:()=>{t.state.conditionWrap=!t.state.conditionWrap,t.state.layerSelect=!1},openLayerSelect:()=>{t.state.layerSelect=!t.state.layerSelect,t.state.conditionWrap=!1},onLayerControl:({action:o,value:d})=>{t.layerControl({action:o,value:d})},onChangeTarget:o=>{t.changeTarget(o)},onConditionWrap:c[9]||(c[9]=o=>{t.conditionWrap(o)})},null,8,["dimensionMapStatus","currentLayers","mapCount","openConditionWrap","openLayerSelect","onLayerControl","onChangeTarget"])]),t.state.deleteLightbox?(f(),S("div",$e,[u("div",et,[tt,u("div",at,[u("button",{class:"rounded px-3 py-1 bg-steel text-white border-0",onClick:c[10]||(c[10]=()=>{t.layerControl({action:"selectLayerMode",value:{layerName:"all"}}),t.state.deleteLightbox=!1})},"確定"),u("button",{class:"rounded px-3 py-1 bg-secondary bg-gradient text-white border-0",onClick:c[11]||(c[11]=()=>{t.state.deleteLightbox=!1})},"取消")])])])):h("",!0),u("div",{id:"popup",class:"position-absolute bottom-0",ref:o=>{t.state.popup.nodeRef=o}},[t.state.popup.popupId!==0?(f(),oe(Z,{key:0,class:"areaData",closeMapData:()=>{t.closeMapData()},popup:t.state.popup,maxHeight:500},null,8,["closeMapData","popup"])):h("",!0)],512),t.store.state.isInit?(f(),S("div",{key:1,class:"stepOverLayer position-absolute top-0 start-0 w-100 h-100 bg-black opacity-50",id:"firstEnter",onClick:c[12]||(c[12]=()=>{t.store.dispatch("updateLayerStatus",!1)})})):h("",!0)])}const it=Ee(Fe,[["render",ot]]);export{it as default};
//# sourceMappingURL=Wes-a1f3efe1.js.map
