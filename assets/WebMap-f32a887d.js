import{V as pe,g as ye,O as Q,T as ue,X as me,S as K,I as $,m as G,M as J,b as R,a as ge,c as be,d as fe,_ as Le,e as he,f as _e,h as Ce,i as xe,j as Se,k as Ie,l as we,n as Ne,o as ke,p as Me,F as Te,P as De,q as ve,r as We}from"./OLCesium-03cc142e.js";import{_ as Oe,r as Ae,f as ee,g as Ee,$ as q,n as te,c as C,a as u,h as ae,i as h,j as x,m as A,k as ze,l as Be,q as oe,u as je,o as f}from"./index-c603dc2e.js";const Ve={props:{},setup(H,{emit:d}){const S=G,t=je(),e=Ae({defaultCenter:[121.326776,24.655499],defaultCenterZoom:14,targetNum:1,conditionWrap:!1,layerSelect:!1,currentLayers:[],layers:[],mapLayers:ee(()=>e.layers.map((r,a)=>({label:r.group_title,value:r.value,layers:r.group_layers,groupClass:r.group_class}))),selectLock:!1,mapCount:1,map1:null,map2:null,map1LayerStatus:[],map2LayerStatus:[],temp:{map1BaseStatus:0,map2BaseStatus:0},deleteLightbox:!1,dimensionMap:{map1:"2D",map2:"2D"},toSearchDimensionStatus:ee(()=>{let r=e.targetNum==1?"map1":"map2";return e.dimensionMap[r]==="2D"}),ol3d:null,selectValueTemp:0,popup:{nodeRef:null,overlay:null,popupId:0,coordinate:[],popupData:""},comSize:{wrapHeight:"",wrapWidth:""},tribeQuery:{}});let L=null;const v=new pe({projection:"EPSG:4326",center:e.defaultCenter,zoom:e.defaultCenterZoom});function F(){e.map1=new J({target:"map1",layers:[R.getBaseMapData(0)],view:v,controls:[]}),e.map1.addControl(new Ne({units:"metric"}))}function P(r,a){const s=new ke({source:new Me({features:[new Te({geometry:new De([r,a]),population:4e3,rainfall:500})]}),style:new K({image:new $({anchor:[.5,100],anchorXUnits:"fraction",anchorYUnits:"pixels",src:ve})})});let n=e.targetNum==1?"map1":"map2";e[n].addLayer(s)}function W({action:r,value:a}){var c;let s=((c=e.map1)==null?void 0:c.getTarget())==null?"map2":"map1",n=e[s].getView();switch(r){case"In":n.animate({zoom:n.getZoom()+1});break;case"Out":n.animate({zoom:n.getZoom()-1});break;case"toNorth":n.animate({rotation:0});break;case"moveTo":if(a){const{xAxis:m,yAxis:w}=a;n.animate({center:[m,w],zoom:17,duration:100})}else navigator.geolocation.getCurrentPosition(function(m){n.animate({center:[m.coords.longitude,m.coords.latitude],zoom:17,duration:100}),P(m.coords.longitude,m.coords.latitude)});break;case"fullScreen":let i=document.getElementById(`map${e.targetNum}`);i.requestFullscreen?i.requestFullscreen():i.msRequestFullscreen?i.msRequestFullscreen():i.mozRequestFullScreen?i.mozRequestFullScreen():i.webkitRequestFullscreen&&i.webkitRequestFullscreen();break}}function I({action:r,value:a}){var m;let s=e.targetNum==1?e.map1:e.map2,n=s==null?void 0:s.getLayers();switch(r){case"layerMode":if(a.checked){e.layers[a.nodeIndex].group_layers[a.subNodeIndex].single_tiles||(n.getArray().forEach(b=>{b.get("id")&&b.get("id").includes(`node${a.nodeIndex}_subNode${a.subNodeIndex}_nestedSubNode`)&&s.removeLayer(b)}),M("delete",s.getTarget(),a.id));let p=a.nestedSubNodeIndex||e.selectValueTemp,y=S.getLayer(e.layers[a.nodeIndex].group_layers[a.subNodeIndex],p,a.id);if(s.addLayer(y),(m=y.get("label"))!=null&&m.includes("雷達回波預測")){var c=y.getSource(),i=c.getFeatures()[0];const g=e.layers[a.nodeIndex].group_layers[a.subNodeIndex].image_options.image_extent,b=y.get("extra").url,V=gifler(b),U=g[2]-g[0],k=g[3]-g[1];V.frames(document.createElement("canvas"),function(D,_){const ie=U/_.width,le=k/_.height,de=Math.min(ie,le),ce=e.map1.getView().getResolution();i.setStyle(new K({image:new $({img:D.canvas,imgSize:[_.width,_.height],opacity:.8,scale:de/ce})})),D.clearRect(0,0,_.width,_.height),D.drawImage(_.buffer,_.x,_.y),s.render()},!0)}e.layers[a.nodeIndex].group_layers[a.subNodeIndex].layer_type==="WFS"&&(o(s,y.label),X(a)),M("add",s.getTarget(),a.id)}else{let y=function(V){p.filter(k=>{var D;return(D=k==null?void 0:k.get("id"))==null?void 0:D.includes(V)}).forEach(k=>{s.removeLayer(k)})},p=n.getArray();const b={node9_subNode0_nestedSubNode:"node9_subNode0_nestedSubNode",node12_subNode1_nestedSubNode:"node12_subNode1_nestedSubNode"}[a.id]||a.id;y(b),e.layers[a.nodeIndex].group_layers[a.subNodeIndex].layer_type==="WFS"&&(X(a),e.popup.popupId=0,e.popup.popupData="",e.popup.overlay&&(s.removeOverlay(e.popup.overlay),e.popup.overlay=null)),M("delete",s.getTarget(),a.id)}break;case"selectLayerMode":if(e.selectLock)return;a.layerName==="all"?n.getArray().filter(g=>g.get("id")!==void 0).forEach(g=>{s.removeLayer(g)}):n.getArray().forEach(y=>{y.get("id")==a.id&&s.removeLayer(y)});break;case"changeOrder":if(e.selectLock)return;let{nodeIndex:w,subNodeIndex:T,nestedSubNodeIndex:N}=S.getLayerIndex(a.id),B=S.getLayer(e.layers[w].group_layers[T],N,a.id);if(a.movement==="up"){if(a.key+1==n.getArray().length)return;let p={checked:!1,nodeIndex:w,subNodeIndex:T,nestedSubNodeIndex:N,id:a.id};I({action:"layerMode",value:p}),n.insertAt(a.key+1,B)}if(a.movement==="down"){if(a.key-1==0)return;let p={checked:!1,nodeIndex:w,subNodeIndex:T,nestedSubNodeIndex:N,id:a.id};I({action:"layerMode",value:p}),n.insertAt(a.key-1,B)}break;case"changeLayerVisible":if(e.selectLock)return;let Z=!n.getArray()[a.key].getVisible();n.getArray()[a.key].setVisible(Z);break;case"baseMap":e.temp[`map${e.targetNum}BaseStatus`]=a.baseId;let re=new ue({preload:1/0,name:a.name,label:a.label,type:a.mapType,baseId:a.baseId,source:new me({url:a.url}),crossOrigin:"anonymous"}),se=s==null?void 0:s.getLayers().getArray();n.insertAt(0,re),se.forEach(p=>(p.get("type")=="base"&&p.get("baseId")!==a.baseId&&s.removeLayer(p),!0));break;case"changeDimensionMap":let j=e.targetNum==1?"map1":"map2";if(e.dimensionMap[j]=a,a==="3D"){const y=n.getArray().find(b=>b.get("label").includes("近年歷史災害82處部落點位"));y&&e[`map${e.targetNum}`].removeLayer(y),L=new Q({map:s}),L.setEnabled(!0),Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NzM3MWFhYS0xMjNlLTQ3MTMtODFjZS0xZjMzM2I5NGZiYTEiLCJpZCI6MTMwODE4LCJpYXQiOjE2ODQwNzM3Mjl9.UYu4kBialPo19dcvosHzZTpg2BD1zkFQnjCD78YiiYo";let g=L.getCesiumScene({});g.terrainProvider=Cesium.createWorldTerrain({}),e[`${j}LayerStatus`].push("3D")}else L.setEnabled(!1),e[`${j}LayerStatus`]=e[`${j}LayerStatus`].filter(p=>p!=="3D"),e[`map${e.targetNum}LayerStatus`].forEach(p=>{let{nodeIndex:y,subNodeIndex:g,nestedSubNodeIndex:b}=S.getLayerIndex(p);return S.getLayer(e.layers[y].group_layers[g],b,a.id).get("label").includes("近年歷史災害82處部落點位")&&I({action:"layerMode",value:{checked:!0,nodeIndex:y,subNodeIndex:g,nestedSubNodeIndex:b,id:p}}),p});break;case"setOpacity":n.getArray()[a.key].setOpacity(Number(a.value));break}O()}function E(r){var c;if(e.mapCount===r)return;let a=e.targetNum!==1?"map1":"map2";e.mapCount=r;let n=e[`${a}LayerStatus`].filter(i=>i!=="3D").map(i=>G.getLayerIndex(i));if(r===2&&(e[a]=new J({target:a,layers:[R.getBaseMapData(0),...n.map(i=>S.getLayer(e.layers[i.nodeIndex].group_layers[i.subNodeIndex],i.nestedSubNodeIndex,i.id))],view:v,controls:[]}),((c=e[`${a}LayerStatus`])==null?void 0:c.indexOf("3D"))!==-1)){L=new Q({map:e[a]}),L.setEnabled(!0),Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NzM3MWFhYS0xMjNlLTQ3MTMtODFjZS0xZjMzM2I5NGZiYTEiLCJpZCI6MTMwODE4LCJpYXQiOjE2ODQwNzM3Mjl9.UYu4kBialPo19dcvosHzZTpg2BD1zkFQnjCD78YiiYo";let i=L.getCesiumScene({});i.terrainProvider=Cesium.createWorldTerrain({})}if(r===1){e[a]=null;const i=document.getElementById(a);for(;i.firstChild;)i.removeChild(i.firstChild)}}function Y(r){var s;e.targetNum=r;let a=e.targetNum!==1?"map1":"map2";if(e.mapCount===1){if(!e[`map${r}`]){let n=e[`map${r}LayerStatus`].filter(i=>i!=="3D");n.includes("node0_subNode4_nestedSubNodeundefined")&&(n=[...n.filter(m=>m!=="node0_subNode4_nestedSubNodeundefined"),"node0_subNode4_nestedSubNodeundefined"]);let c=n.map(i=>G.getLayerIndex(i));e[`map${r}`]=new J({target:`map${r}`,layers:[R.getBaseMapData(e.temp[`map${e.targetNum}BaseStatus`]),...c.map(i=>S.getLayer(e.layers[i.nodeIndex].group_layers[i.subNodeIndex],i.nestedSubNodeIndex,i.layeredIndex))],view:v,controls:[]}),o(e[`map${r}`]),((s=e[`map${r}LayerStatus`])==null?void 0:s.indexOf("3D"))!==-1&&(L=new Q({map:e[`map${r}`]}),L.setEnabled(!0))}if(e[a]){e[a]=null;const n=document.getElementById(a);for(;n.firstChild;)n.removeChild(n.firstChild)}}te(()=>{O()})}function O(){var s;let r=e.targetNum==1?e.map1:e.map2;const a=(s=r==null?void 0:r.getLayers())==null?void 0:s.getArray();e.currentLayers=a==null?void 0:a.map(n=>({label:n.get("label"),id:n.get("id"),visible:n.getVisible()}))}function z(){e.conditionWrap=!e.conditionWrap}function M(r,a,s){if(r==="add")e[`${a}LayerStatus`].push(s);else if(r==="delete"){let n=e[`${a}LayerStatus`].findIndex(c=>c===s);e[`${a}LayerStatus`].splice(n,1)}else console.log("error")}function o(r){var s;let a=new ge({layers:(s=r==null?void 0:r.getLayers())==null?void 0:s.getArray(),condition:be});r.addInteraction(a),a.on("select",n=>{let c=n.selected[0];if(c){e.popup.overlay=new fe({element:e.popup.nodeRef,autoPan:!0,autoPanAnimation:{duration:250}}),e.popup.overlay.setPosition(n.mapBrowserEvent.coordinate),r.addOverlay(e.popup.overlay);let i=c.getId().split(".");e.popup.popupData=i[0],e.popup.coordinate=n.mapBrowserEvent.coordinate,i[0]==="新竹縣原住民部落範圍"&&(e.popup.popupId=c.get("編號")),i[0]==="近年歷史災害82處部落點位"&&(e.popup.popupId=i[1])}else r.removeOverlay(e.popup.overlay),e.popup.overlay=null,e.popup={nodeRef:null,overlay:null,popupId:0,coordinate:[],popupData:""}})}function l(){(e.targetNum==1?e.map1:e.map2).removeOverlay(e.popup.overlay),e.popup.overlay=null}function X(r){const{checked:a,id:s}=r;if(!a){e.selectLayerOption={};return}s==="node4_subNode0_nestedSubNodeundefined"&&q.ajax({url:"https://api.edtest.site/tribeQuery",method:"GET",success:n=>{e.tribeQuery=n},error:n=>{console.log(n)}})}function ne(r){let a={action:"moveTo",value:{xAxis:r.WGS84.lng,yAxis:r.WGS84.lat}};W(a)}return Ee(async()=>{let r=q.ajax({url:"https://api.edtest.site/underLayers",method:"GET"}).done(s=>s),a=q.ajax({url:"https://api.edtest.site/layers",method:"GET"}).done(s=>s);Promise.all([r,a]).then(s=>{let n=s[0].data.map((c,i)=>({mapType:"base",baseId:i,onCurrent:!1,...c}));R.setBaseMapData(n),e.temp.map1BaseStatus=0,e.temp.baseMapList=ye(),e.layers=s[1].map((c,i)=>(c.group_layers.forEach((m,w)=>{let T=w,N;m.id=`node${i}_subNode${T}_nestedSubNode${N}`,m.single_tiles||m.tiles_list.forEach((B,Z)=>{N=Z,B.id=`node${i}_subNode${T}_nestedSubNode${N}`})}),{...c,value:i})),te(()=>{F(),O()})}),e.comSize.wrapHeight=window.innerHeight,e.comSize.wrapWidth=window.innerWidth,window.onresize=s=>{e.comSize.wrapHeight=s.target.innerHeight,e.comSize.wrapWidth=s.target.innerWidth}}),{state:e,props:H,store:t,mapControl:W,layerControl:I,changeTarget:Y,conditionWrap:z,closeMapData:l,moveToMap:ne,changeMapCount:E}}},Re={class:"w-100 d-flex justify-content-between flex-sm-row flex-wrap flex-sm-nowrap mapWrap",id:"mapWrap"},Fe={key:0,class:"middleLine"},Pe={class:"SearchBar d-none d-sm-block position-absolute"},Ye={class:"d-flex align-items-center"},Ze=u("img",{src:Le,alt:"",class:"me-5"},null,-1),Qe={class:"conditionCom d-none d-sm-block position-absolute"},Ge={class:"mb-4"},Je={key:1},qe={class:"m-Navbar d-flex d-sm-none position-fixed bottom-0 start-0 w-100"},He={class:"position-absolute bottom-100 w-100",style:{"max-height":"70vh","overflow-y":"scroll"}},Xe={key:0},Ue={key:0,class:"lightWrap w-100 h-100 d-flex justify-content-center align-items-center"},Ke={class:"p-4 rounded bg-white",style:{width:"250px"}},$e=u("p",{class:"text-center fw-bold"},"是否要取消全部圖層",-1),et={class:"d-flex justify-content-around"};function tt(H,d,S,t,e,L){var z,M;const v=he,F=_e,P=Ce,W=xe,I=We,E=Se,Y=Ie,O=we;return f(),C("div",null,[u("div",Re,[u("div",{id:"map1",class:ae({"w-100":((z=t.state.map1)==null?void 0:z.getTarget())=="map1","h-100":t.state.mapCount===1,"h-50":t.state.mapCount===2&&t.state.comSize.wrapWidth<600,middleMap:t.state.mapCount===2})},null,2),t.state.mapCount===2?(f(),C("div",Fe)):h("",!0),u("div",{id:"map2",class:ae({"w-100":((M=t.state.map2)==null?void 0:M.getTarget())=="map2","h-100":t.state.mapCount===1,"h-50":t.state.mapCount===2&&t.state.comSize.wrapWidth<600,middleMap:t.state.mapCount===2})},null,2)]),x(v,{class:"asideTool position-absolute top-50 translate-middle-y",id:"asideTool",onOnMapControl:d[0]||(d[0]=({action:o,value:l})=>{t.mapControl({action:o,value:l})})}),u("div",Pe,[u("div",Ye,[Ze,x(F,{class:"mapSourceOption d-none d-sm-block",baseMapList:t.state.temp.baseMapList,onChangeBaseMaps:({action:o,value:l})=>{t.layerControl({action:o,value:l})}},null,8,["baseMapList","onChangeBaseMaps"])]),x(P,A({class:"mt-4"},{dimensionMapStatus:t.state.toSearchDimensionStatus,currentLayers:t.state.currentLayers,mapCount:t.state.mapCount,onChangeBaseMaps:({action:o,value:l})=>{t.layerControl({action:o,value:l})},onChangeMapCount:o=>{t.changeMapCount(o)}},{onOnLayerControl:d[1]||(d[1]=({action:o,value:l})=>{t.layerControl(o,l)}),onOnChangeTarget:d[2]||(d[2]=o=>{t.changeTarget(o)}),onConditionWrap:d[3]||(d[3]=o=>{t.conditionWrap(o)})}),null,16)]),u("div",Qe,[u("div",Ge,[t.state.conditionWrap?h("",!0):(f(),C("button",{key:0,class:"border-0 w-100 rounded-4 bg-steel text-white text-center p-2 fw-bold fs-5",onClick:d[4]||(d[4]=o=>t.state.conditionWrap=!0)}," 圖層選項 ")),t.state.conditionWrap?(f(),C("div",{key:1,class:"mb-4","on:onLayerControl":d[6]||(d[6]=({action:o,value:l})=>{t.layerControl({action:o,value:l})})},[x(W,A({tribeQuery:t.state.tribeQuery,mapLayers:t.state.mapLayers,currentLayers:t.state.currentLayers,onClose:()=>{t.state.conditionWrap=!1},showSelectLayerValue:o=>{t.state.selectValueTemp=o},moveToMap:o=>{t.moveToMap(o)}},{onOnLayerControl:d[5]||(d[5]=({action:o,value:l})=>{t.layerControl({action:o,value:l})})}),null,16)],32)):h("",!0),x(I,{text:"可選擇要加入的圖層",styles:"right: 105%;top: 0;text-align: right;"})]),u("div",null,[t.state.layerSelect?h("",!0):(f(),C("button",{key:0,class:"border-0 w-100 rounded-4 bg-steel text-white text-center p-2 fw-bold fs-5",onClick:d[7]||(d[7]=o=>t.state.layerSelect=!0)}," 已選擇的圖層 ")),t.state.layerSelect?(f(),C("div",Je,[x(E,ze(Be({selectLock:t.state.selectLock,currentLayers:t.state.currentLayers,onClose:()=>{t.state.layerSelect=!1},onLockLayer:()=>{t.state.selectLock=!t.state.selectLock},onDeleteLayer:({action:o,value:l})=>{l.layerName=="all"?t.state.deleteLightbox=!0:t.layerControl({action:o,value:l})},onDeleteLayerAll:()=>{t.state.deleteLightbox=!0},onLayerControl:({action:o,value:l})=>{t.layerControl({action:o,value:l})}})),null,16)])):h("",!0),x(I,{text:"顯示已經選擇的圖層",styles:"right: 105%;top: 0;text-align: right;"})])]),u("div",qe,[u("div",He,[t.state.conditionWrap?(f(),oe(W,A({key:0,class:"w-100"},{mapLayers:t.state.mapLayers,currentLayers:t.state.currentLayers,onClose:()=>{t.state.conditionWrap=!1},showSelectLayerValue:o=>{t.state.selectValueTemp=o}},{onOnLayerControl:d[8]||(d[8]=({action:o,value:l})=>{t.layerControl({action:o,value:l})})}),null,16)):h("",!0)]),t.state.layerSelect?(f(),C("div",Xe,[x(E,A({class:"position-absolute bottom-100 w-100"},{selectLock:t.state.selectLock,currentLayers:t.state.currentLayers,onClose:()=>{t.state.layerSelect=!1},onLockLayer:()=>{t.state.selectLock=!t.state.selectLock},onDeleteLayer:({action:o,value:l})=>{l.layerName=="all"?t.state.deleteLightbox=!0:t.layerControl({action:o,value:l})},onDeleteLayerAll:()=>{t.state.deleteLightbox=!0},onChangLayerVisible:o=>{t.layerControl(o)},onChangeOrderLayer:({action:o,value:l})=>{t.layerControl({action:o,value:l})},onLayerControl:({action:o,value:l})=>{t.layerControl({action:o,value:l})}}),null,16)])):h("",!0),x(Y,A({dimensionMapStatus:t.state.toSearchDimensionStatus,currentLayers:t.state.currentLayers,mapCount:t.state.mapCount,openConditionWrap:()=>{t.state.conditionWrap=!t.state.conditionWrap,t.state.layerSelect=!1},openLayerSelect:()=>{t.state.layerSelect=!t.state.layerSelect,t.state.conditionWrap=!1},onLayerControl:({action:o,value:l})=>{t.layerControl({action:o,value:l})},onChangeMapCount:o=>{t.changeMapCount(o)},onChangeTarget:o=>{t.changeTarget(o)}},{onConditionWrap:d[9]||(d[9]=o=>{t.conditionWrap(o)})}),null,16)]),t.state.deleteLightbox?(f(),C("div",Ue,[u("div",Ke,[$e,u("div",et,[u("button",{class:"rounded px-3 py-1 bg-steel text-white border-0",onClick:d[10]||(d[10]=()=>{t.layerControl({action:"selectLayerMode",value:{layerName:"all"}}),t.state.deleteLightbox=!1})},"確定"),u("button",{class:"rounded px-3 py-1 bg-secondary bg-gradient text-white border-0",onClick:d[11]||(d[11]=()=>{t.state.deleteLightbox=!1})},"取消")])])])):h("",!0),u("div",{id:"popup",class:"position-absolute bottom-0",ref:o=>{t.state.popup.nodeRef=o}},[t.state.popup.popupId!==0?(f(),oe(O,{key:0,class:"areaData",closeMapData:()=>{t.closeMapData()},popup:t.state.popup,maxHeight:500},null,8,["closeMapData","popup"])):h("",!0)],512),t.store.state.isInit?(f(),C("div",{key:1,class:"stepOverLayer position-absolute top-0 start-0 w-100 h-100 bg-black opacity-50",id:"firstEnter",onClick:d[12]||(d[12]=()=>{t.store.dispatch("updateLayerStatus",!1)})})):h("",!0)])}const nt=Oe(Ve,[["render",tt]]);export{nt as default};
//# sourceMappingURL=WebMap-f32a887d.js.map
